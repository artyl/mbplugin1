@echo OFF
%~d0 
cd "%~dp0"


@REM добавляем в sys.path поиск в папке откуда запущен скрипт по умолчанию, в embedded он почему-то выключен
cd python 
..\python\python -c "txt='''import os,sys\nsys.path.insert(0,os.path.split(sys.argv[0])[0])''';open('sitecustomize.py','w').write(txt)"

cd "%~dp0"
echo Пересобираем DLL 
call dllsource\compile_all_p.bat

cd "%~dp0"
echo Пересобираем JSMB LH plugin
python\python.exe plugin\compile_all_jsmblh.py

cd "%~dp0"
if NOT "%1"=="noweb" echo Создаем lnk на run_webserver.bat и помещаем его в автозапуск и запускаем
if NOT "%1"=="noweb" python\python -c "import os, sys, win32com.client;shell = win32com.client.Dispatch('WScript.Shell');shortcut = shell.CreateShortCut('run_webserver.lnk');shortcut.Targetpath = os.path.abspath('run_webserver.bat');shortcut.save()"
if NOT "%1"=="noweb" copy run_webserver.lnk "%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup"
if NOT "%1"=="noweb" start "" /MIN "%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\run_webserver.lnk"
if NOT "%1"=="noweb" echo подождем пока запустится
if NOT "%1"=="noweb" ping 127.0.0.1 -n 11 >nul

cd "%~dp0"
echo Проверяем что все модули импортируются
python\python -c "import requests, telegram, win32api, win32gui, win32con, winerror, PIL, bs4, pyodbc, pyreadline, pyppeteer, psutil"

cd "%~dp0"
if NOT "%1"=="noweb" echo Проверяем что все работает JSMB LH PLUGIN простой плагин
if NOT "%1"=="noweb" python\python -c "import re,requests;url=re.findall(r'(?usi)(http://127.0.0.1:.*?/)',open('jsmblhplugin\\p_test1_localweb.jsmb').read())[0];print(requests.session().get(url+'getbalance/p_test1/123/456/789').content.decode('cp1251'))"

cd "%~dp0"
if NOT "%1"=="noweb" echo Проверяем что все работает JSMB LH PLUGIN через Chrome
if NOT "%1"=="noweb" python\python -c "import re,requests;url=re.findall(r'(?usi)(http://127.0.0.1:.*?/)',open('jsmblhplugin\\p_test3_localweb.jsmb').read())[0];print(requests.session().get(url+'getbalance/p_test3/demo@saures.ru/demo/789').content.decode('cp1251'))"

cd "%~dp0"
echo Проверяем что все работает DLL PLUGIN
call plugin\test_mbplugin_dll_call.bat p_test1 123 456 
